version: "3.8"

services:
  minecraft:
    image: itzg/minecraft-server
    volumes:
      - /home/minecraft/data:/data
      - /home/minecraft/plugins:/plugins
      - /home/minecraft/mods:/mods
    ports:
      - 25565:25565
    environment:
      TZ: "America/Chicago"
      LOG_TIMESTAMP: "TRUE"
      OVERRIDE_SERVER_PROPERTIES: "FALSE"
      EULA: "TRUE"
      TYPE: "PAPER"
      OPS: <>
      ENABLE_WHITELIST: "TRUE"
      ENFORCE_WHITELIST: "TRUE"
      USE_AIKAR_FLAGS: "TRUE"
      MEMORY: "22G"
    tty: true
    stdin_open: true
    restart: on-failure
    
  mc-backup:
    image: itzg/mc-backup
    depends_on:
      minecraft:
        condition: service_healthy
    environment:
      TZ: "America/Chicago"
      BACKUP_INTERVAL: "24h"
      PAUSE_IF_NO_PLAYERS: "TRUE"
      RCON_HOST: minecraft
      RCON_PASSWORD: <>
      INITIAL_DELAY: 0
      BACKUP_METHOD: restic
      RESTIC_PASSWORD: <>
      RESTIC_REPOSITORY: /restic-repo
      RESTIC_ADDITIONAL_TAGS: mc-backups
      PRUNE_RESTIC_RETENTION: "--keep-daily 3 --keep-weekly 4 --keep-monthly 12 --keep-yearly 75"
      PRE_BACKUP_SCRIPT: |
        echo "Before backup!"
      POST_BACKUP_SCRIPT: |
        echo "Backup complete! surely..."
      restart: unless-stopped
    volumes:
      - /home/minecraft/data:/data:ro
      - /home/restic-repo:/restic-repo

  restarter:
    image: docker:cli
    volumes: ["/var/run/docker.sock:/var/run/docker.sock"]
    entrypoint: ["/bin/sh","-c"]
    command:
      - |
        while true; do
          if [ "$(date +'%H:%M')" = '10:00' ]; then
            docker exec mc-server-minecraft-1 mc-send-to-console "say Server will restart in 5 minutes!"
            echo "RESTARTER: shutdown message sent"
            echo "RESTARTER: restarting in 5 minutes"
            sleep 300
            docker exec mc-server-minecraft-1 mc-send-to-console stop
            echo "RESTARTER: stopping server"
            sleep 20
            docker restart mc-server-minecraft-1
            echo "RESTARTER: container restarted"
          fi
          sleep 60
        done
    restart: unless-stopped
